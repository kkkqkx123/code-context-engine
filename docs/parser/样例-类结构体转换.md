# 类/结构体转换样例

## 概述

本文档展示如何将不同编程语言的类和结构体转换为自然语言表示，以提高通用NLP嵌入模型的语义理解能力。

## 转换模板

### 类模板

```
Class {normalizedName} {docstringPart} with fields {fields} and methods {methods} {context}
```

### 结构体模板

```
Struct {normalizedName} {docstringPart} with fields {fields} and methods {methods} {context}
```

## 样例1：Rust结构体

### 输入代码

```rust
/// Represents a user in the system
pub struct User {
    /// Unique identifier for the user
    pub id: u64,
    /// User's display name
    pub name: String,
    /// User's email address
    pub email: String,
    /// Whether the user is active
    pub is_active: bool,
}

impl User {
    /// Create a new user instance
    pub fn new(id: u64, name: String, email: String) -> Self {
        User {
            id,
            name,
            email,
            is_active: true,
        }
    }

    /// Check if the user is active
    pub fn is_active(&self) -> bool {
        self.is_active
    }
}
```

### AST解析信息

- **结构体名**: `User`
- **文档字符串**: `Represents a user in the system`
- **字段**:
  - `id`: u64
  - `name`: String
  - `email`: String
  - `is_active`: bool
- **方法**:
  - `new`: 创建新用户实例
  - `is_active`: 检查用户是否活跃
- **上下文**: 模块 `user`, 文件 `user.rs`

### 转换步骤

1. **命名规范化**:
   - `User` → `User`

2. **文档字符串清洗**:
   - `Represents a user in the system`

3. **字段规范化**:
   - `id: u64` → `id u64`
   - `name: String` → `name string`
   - `email: String` → `email string`
   - `is_active: bool` → `is active bool`

4. **方法规范化**:
   - `new` → `new`
   - `is_active` → `is active`

5. **上下文提取**:
   - `module user file user`

6. **文本组装**:
   ```
   Struct User that does Represents a user in the system with fields id u64 name string email string is active bool and methods new is active module user file user
   ```

### 输出结果

```
Struct User that does Represents a user in the system with fields id u64 name string email string is active bool and methods new is active module user file user
```

---

## 样例2：JavaScript类

### 输入代码

```javascript
/**
 * Represents a shopping cart that holds items
 */
class ShoppingCart {
    /**
     * Create a new shopping cart
     * @param {string} userId - The user ID associated with this cart
     */
    constructor(userId) {
        this.userId = userId;
        this.items = [];
        this.createdAt = new Date();
    }

    /**
     * Add an item to the cart
     * @param {Object} item - The item to add
     */
    addItem(item) {
        this.items.push(item);
    }

    /**
     * Calculate the total price of all items
     * @returns {number} The total price
     */
    calculateTotal() {
        return this.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    }

    /**
     * Clear all items from the cart
     */
    clear() {
        this.items = [];
    }
}
```

### AST解析信息

- **类名**: `ShoppingCart`
- **文档字符串**: `Represents a shopping cart that holds items`
- **字段**:
  - `userId`: string
  - `items`: array
  - `createdAt`: Date
- **方法**:
  - `constructor`: 创建购物车
  - `addItem`: 添加商品
  - `calculateTotal`: 计算总价
  - `clear`: 清空购物车
- **上下文**: 文件 `cart.js`

### 转换步骤

1. **命名规范化**:
   - `ShoppingCart` → `shopping cart`

2. **文档字符串清洗**:
   - `Represents a shopping cart that holds items`

3. **字段规范化**:
   - `userId: string` → `user id string`
   - `items: array` → `items array`
   - `createdAt: Date` → `created at date`

4. **方法规范化**:
   - `constructor` → `constructor`
   - `addItem` → `add item`
   - `calculateTotal` → `calculate total`
   - `clear` → `clear`

5. **上下文提取**:
   - `file cart`

6. **文本组装**:
   ```
   Class Shopping cart that does Represents a shopping cart that holds items with fields user id string items array created at date and methods constructor add item calculate total clear file cart
   ```

### 输出结果

```
Class Shopping cart that does Represents a shopping cart that holds items with fields user id string items array created at date and methods constructor add item calculate total clear file cart
```

---

## 样例3：Python类

### 输入代码

```python
"""
Represents a user account in the system
"""
class UserAccount:
    def __init__(self, username, email):
        """
        Initialize a new user account
        
        Args:
            username: The unique username
            email: The user's email address
        """
        self.username = username
        self.email = email
        self.created_at = datetime.now()
        self.is_active = True
    
    def authenticate(self, password):
        """
        Authenticate the user with the provided password
        
        Args:
            password: The password to verify
            
        Returns:
            bool: True if authentication succeeds
        """
        return verify_password(self.email, password)
    
    def update_email(self, new_email):
        """
        Update the user's email address
        
        Args:
            new_email: The new email address
        """
        self.email = new_email
        self.save()
    
    def deactivate(self):
        """Deactivate the user account"""
        self.is_active = False
        self.save()
```

### AST解析信息

- **类名**: `UserAccount`
- **文档字符串**: `Represents a user account in the system`
- **字段**:
  - `username`: string
  - `email`: string
  - `created_at`: datetime
  - `is_active`: bool
- **方法**:
  - `__init__`: 初始化用户账户
  - `authenticate`: 验证用户身份
  - `update_email`: 更新邮箱
  - `deactivate`: 停用账户
- **上下文**: 文件 `account.py`

### 转换步骤

1. **命名规范化**:
   - `UserAccount` → `user account`

2. **文档字符串清洗**:
   - `Represents a user account in the system`

3. **字段规范化**:
   - `username: string` → `username string`
   - `email: string` → `email string`
   - `created_at: datetime` → `created at datetime`
   - `is_active: bool` → `is active bool`

4. **方法规范化**:
   - `__init__` → `init`
   - `authenticate` → `authenticate`
   - `update_email` → `update email`
   - `deactivate` → `deactivate`

5. **上下文提取**:
   - `file account`

6. **文本组装**:
   ```
   Class User account that does Represents a user account in the system with fields username string email string created at datetime is active bool and methods init authenticate update email deactivate file account
   ```

### 输出结果

```
Class User account that does Represents a user account in the system with fields username string email string created at datetime is active bool and methods init authenticate update email deactivate file account
```

---

## 样例4：Java类

### 输入代码

```java
/**
 * Represents a product in the e-commerce system
 */
public class Product {
    private String id;
    private String name;
    private double price;
    private int stock;
    private String category;
    
    /**
     * Create a new product
     * @param id the product ID
     * @param name the product name
     * @param price the product price
     * @param stock the stock quantity
     * @param category the product category
     */
    public Product(String id, String name, double price, int stock, String category) {
        this.id = id;
        this.name = name;
        this.price = price;
        this.stock = stock;
        this.category = category;
    }
    
    /**
     * Check if the product is in stock
     * @return true if stock > 0
     */
    public boolean isInStock() {
        return this.stock > 0;
    }
    
    /**
     * Reduce stock by the specified quantity
     * @param quantity the quantity to reduce
     * @throws IllegalArgumentException if quantity > stock
     */
    public void reduceStock(int quantity) {
        if (quantity > this.stock) {
            throw new IllegalArgumentException("Insufficient stock");
        }
        this.stock -= quantity;
    }
    
    /**
     * Get the product ID
     * @return the product ID
     */
    public String getId() {
        return this.id;
    }
}
```

### AST解析信息

- **类名**: `Product`
- **文档字符串**: `Represents a product in the e-commerce system`
- **字段**:
  - `id`: String
  - `name`: String
  - `price`: double
  - `stock`: int
  - `category`: String
- **方法**:
  - `Product`: 构造函数
  - `isInStock`: 检查库存
  - `reduceStock`: 减少库存
  - `getId`: 获取产品ID
- **上下文**: 文件 `Product.java`

### 转换步骤

1. **命名规范化**:
   - `Product` → `product`

2. **文档字符串清洗**:
   - `Represents a product in the e-commerce system`

3. **字段规范化**:
   - `id: String` → `id string`
   - `name: String` → `name string`
   - `price: double` → `price double`
   - `stock: int` → `stock int`
   - `category: String` → `category string`

4. **方法规范化**:
   - `Product` → `product`
   - `isInStock` → `is in stock`
   - `reduceStock` → `reduce stock`
   - `getId` → `get id`

5. **上下文提取**:
   - `file product java`

6. **文本组装**:
   ```
   Class Product that does Represents a product in the e-commerce system with fields id string name string price double stock int category string and methods product is in stock reduce stock get id file product java
   ```

### 输出结果

```
Class Product that does Represents a product in the e-commerce system with fields id string name string price double stock int category string and methods product is in stock reduce stock get id file product java
```

---

## 样例5：C结构体

### 输入代码

```c
/* Represents a point in 2D space */
typedef struct {
    double x;  /* X coordinate */
    double y;  /* Y coordinate */
} Point;

/* Represents a rectangle */
typedef struct {
    Point top_left;      /* Top-left corner */
    Point bottom_right;  /* Bottom-right corner */
} Rectangle;

/* Create a new point */
Point create_point(double x, double y) {
    Point p;
    p.x = x;
    p.y = y;
    return p;
}

/* Calculate the area of a rectangle */
double calculate_area(Rectangle rect) {
    double width = rect.bottom_right.x - rect.top_left.x;
    double height = rect.bottom_right.y - rect.top_left.y;
    return width * height;
}
```

### AST解析信息

- **结构体名**: `Point`, `Rectangle`
- **文档字符串**: 
  - `Point`: `Represents a point in 2D space`
  - `Rectangle`: `Represents a rectangle`
- **字段**:
  - `Point`: `x` (double), `y` (double)
  - `Rectangle`: `top_left` (Point), `bottom_right` (Point)
- **相关函数**:
  - `create_point`: 创建点
  - `calculate_area`: 计算面积
- **上下文**: 文件 `geometry.c`

### 转换步骤

1. **命名规范化**:
   - `Point` → `point`
   - `Rectangle` → `rectangle`

2. **文档字符串清洗**:
   - `Represents a point in 2D space`
   - `Represents a rectangle`

3. **字段规范化**:
   - `Point`: `x double y double`
   - `Rectangle`: `top left point bottom right point`

4. **上下文提取**:
   - `file geometry c`

5. **文本组装**:
   ```
   Struct Point that does Represents a point in 2D space with fields x double y double file geometry c
   Struct Rectangle that does Represents a rectangle with fields top left point bottom right point file geometry c
   ```

### 输出结果

```
Struct Point that does Represents a point in 2D space with fields x double y double file geometry c
Struct Rectangle that does Represents a rectangle with fields top left point bottom right point file geometry c
```

---

## 转换要点总结

### 1. 命名规范化

| 原始命名 | 转换后 | 说明 |
|---------|--------|------|
| `User` | `User` | 单词保持原样 |
| `ShoppingCart` | `shopping cart` | 驼峰命名拆分 |
| `UserAccount` | `user account` | 驼峰命名拆分 |
| `Product` | `product` | 首字母小写 |

### 2. 字段处理

- **字段名规范化**：将字段名转换为自然语言
- **类型信息保留**：保留字段类型信息
- **访问修饰符**：可以忽略或保留（如`pub`、`private`）

### 3. 方法处理

- **方法名规范化**：将方法名转换为自然语言
- **特殊方法**：
  - `__init__` → `init`
  - `constructor` → `constructor`
  - `toString` → `to string`
- **getter/setter**：保留方法名

### 4. 继承关系

如果类有继承关系，可以在上下文中补充：

```
Class Dog that does Represents a dog extends Animal with fields name string age int and methods bark fetch file dog
```

### 5. 接口实现

如果类实现了接口，可以在上下文中补充：

```
Class UserService that does Provides user services implements IUserService with methods get_user create_user update_user file user service
```

## 复杂场景处理

### 1. 嵌套类/结构体

#### 输入代码

```rust
pub struct Outer {
    pub inner: Inner,
}

pub struct Inner {
    pub value: i32,
}
```

#### 处理方式

分别转换，在字段中引用嵌套类型：

```
Struct Outer with fields inner inner file outer
Struct Inner with fields value i32 file outer
```

### 2. 泛型类

#### 输入代码

```java
public class Container<T> {
    private T value;
    
    public Container(T value) {
        this.value = value;
    }
    
    public T getValue() {
        return this.value;
    }
}
```

#### 处理方式

保留泛型参数：

```
Class Container T with fields value T and methods container get value file container
```

### 3. 抽象类

#### 输入代码

```python
from abc import ABC, abstractmethod

class Animal(ABC):
    @abstractmethod
    def make_sound(self):
        pass
```

#### 处理方式

标记为抽象类：

```
Class Animal abstract with methods make sound file animal
```

## AST提取逻辑

### Tree-sitter查询示例

```typescript
// JavaScript类查询
const jsClassQuery = `
  (class_declaration
    name: (identifier) @className
    body: (class_body
      (property_definition
        name: (property_identifier) @fieldName
      )*
      (method_definition
        name: (property_identifier) @methodName
      )*
    )
  )
`;

// Python类查询
const pythonClassQuery = `
  (class_definition
    name: (identifier) @className
    body: (block
      (expression_statement
        (assignment
          left: (identifier) @fieldName
        )
      )*
      (function_definition
        name: (identifier) @methodName
      )*
    )
  )
`;

// Rust结构体查询
const rustStructQuery = `
  (struct_item
    name: (type_identifier) @structName
    body: (field_declaration_list
      (field_declaration
        name: (field_identifier) @fieldName
        type: (type_identifier) @fieldType
      )*
    )
  )
`;
```

## 总结

### 核心优势

1. **结构清晰**：类/结构体的字段和方法一目了然
2. **语义保留**：保留类型信息和文档描述
3. **关系明确**：通过字段和方法体现类的功能
4. **易于搜索**：自然语言表示便于语义搜索

### 应用场景

1. **代码理解**：快速了解类的结构和功能
2. **API文档**：自动生成类文档
3. **代码搜索**：通过类名、字段、方法搜索相关代码
4. **重构分析**：分析类的使用和依赖关系

### 后续扩展

1. **继承关系图**：构建类的继承层次结构
2. **组合关系**：分析类之间的组合关系
3. **使用关系**：分析类被其他类使用的情况
4. **设计模式识别**：识别常见的设计模式（如单例、工厂等）